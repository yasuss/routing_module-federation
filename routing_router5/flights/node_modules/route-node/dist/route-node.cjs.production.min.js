"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("path-parser"),r=require("search-params"),n=function(e){var t="";return e.reduce((function(e,r){var n,a,i,s,o=null!=(a=null===(n=r.parser)||void 0===n?void 0:n.urlParams.reduce((function(e,t){return e[t]="url",e}),{}))?a:{},u=null!=(s=null===(i=r.parser)||void 0===i?void 0:i.queryParams.reduce((function(e,t){return e[t]="query",e}),o))?s:{};return void 0!==r.name&&(e[t=t?t+"."+r.name:r.name]=u),e}),{})};exports.RouteNode=function(){function a(e,r,n,a){return void 0===e&&(e=""),void 0===r&&(r=""),void 0===n&&(n=[]),void 0===a&&(a={}),this.name=e,this.absolute=/^~/.test(r),this.path=this.absolute?r.slice(1):r,this.parser=this.path?new t.Path(this.path):null,this.children=[],this.parent=a.parent,this.checkParents(),this.add(n,a.onAdd,!a.finalSort&&!1!==a.sort),a.finalSort&&this.sortDescendants(),this}return a.prototype.getParentSegments=function(e){return void 0===e&&(e=[]),this.parent&&this.parent.parser?this.parent.getParentSegments(e.concat(this.parent)):e.reverse()},a.prototype.setParent=function(e){this.parent=e,this.checkParents()},a.prototype.setPath=function(e){void 0===e&&(e=""),this.path=e,this.parser=e?new t.Path(e):null},a.prototype.add=function(t,r,n){var i=this;if(void 0===n&&(n=!0),null==t)return this;if(t instanceof Array)return t.forEach((function(e){return i.add(e,r,n)})),this;if(!(t instanceof a||t instanceof Object))throw new Error("RouteNode.add() expects routes to be an Object or an instance of RouteNode.");if(t instanceof a)t.setParent(this),this.addRouteNode(t,n);else{if(!t.name||!t.path)throw new Error("RouteNode.add() expects routes to have a name and a path defined.");var s=new a(t.name,t.path,t.children,{finalSort:!1,onAdd:r,parent:this,sort:n}),o=s.getParentSegments([s]).map((function(e){return e.name})).join(".");r&&r(e.__assign(e.__assign({},t),{name:o})),this.addRouteNode(s,n)}return this},a.prototype.addNode=function(e,t){return this.add(new a(e,t)),this},a.prototype.getPath=function(e){var t,r=this.getSegmentsByName(e);return r&&(t=r)?t.map((function(e){return e.path})).join(""):null},a.prototype.getNonAbsoluteChildren=function(){return this.children.filter((function(e){return!e.absolute}))},a.prototype.sortChildren=function(){var e,t;this.children.length&&(t=(e=this.children).slice(0),e.sort(function(e){return function(t,r){var n,a,i,s,o,u,l=t.path.replace(/<.*?>/g,"").split("?")[0].replace(/(.+)\/$/,"$1"),h=r.path.replace(/<.*?>/g,"").split("?")[0].replace(/(.+)\/$/,"$1");if("/"===l)return 1;if("/"===h)return-1;if(null===(n=t.parser)||void 0===n?void 0:n.hasSpatParam)return 1;if(null===(a=r.parser)||void 0===a?void 0:a.hasSpatParam)return-1;var d=(l.match(/\//g)||[]).length,c=(h.match(/\//g)||[]).length;if(d<c)return 1;if(d>c)return-1;var p=null!=(s=null===(i=t.parser)||void 0===i?void 0:i.urlParams.length)?s:0,f=null!=(u=null===(o=r.parser)||void 0===o?void 0:o.urlParams.length)?u:0;if(p<f)return-1;if(p>f)return 1;var m=(l.split("/").slice(-1)[0]||"").length,v=(h.split("/").slice(-1)[0]||"").length;return m<v?1:m>v?-1:e.indexOf(t)-e.indexOf(r)}}(t)))},a.prototype.sortDescendants=function(){this.sortChildren(),this.children.forEach((function(e){return e.sortDescendants()}))},a.prototype.buildPath=function(e,t,n){void 0===t&&(t={}),void 0===n&&(n={});var a=this.getSegmentsByName(e);if(!a)throw new Error("[route-node][buildPath] '{routeName}' is not defined");return function(e,t,n){void 0===t&&(t={}),void 0===n&&(n={});for(var a=n.queryParamsMode,i=void 0===a?"default":a,s=n.trailingSlashMode,o=void 0===s?"default":s,u=[],l=[],h=0,d=e;h<d.length;h++){var c=d[h].parser;c&&(u.push.apply(u,c.queryParams),l.push.apply(l,c.urlParams),l.push.apply(l,c.spatParams))}if("loose"===i){var p=Object.keys(t).reduce((function(e,t){return-1===u.indexOf(t)&&-1===l.indexOf(t)?e.concat(t):e}),[]);u.push.apply(u,p)}var f=u.reduce((function(e,r){return-1!==Object.keys(t).indexOf(r)&&(e[r]=t[r]),e}),{}),m=r.build(f,n.queryParams),v=e.reduce((function(e,r){var a,i,s=null!=(i=null===(a=r.parser)||void 0===a?void 0:a.build(t,{ignoreSearch:!0,queryParams:n.queryParams,urlParamsEncoding:n.urlParamsEncoding}))?i:"";return r.absolute?s:e+s}),"").replace(/\/\/{1,}/g,"/"),g=v;return"always"===o?g=/\/$/.test(v)?v:v+"/":"never"===o&&"/"!==v&&(g=/\/$/.test(v)?v.slice(0,-1):v),g+(m?"?"+m:"")}(a,t,n)},a.prototype.buildState=function(e,t){void 0===t&&(t={});var r=this.getSegmentsByName(e);return r&&r.length?{name:e,params:t,meta:n(r)}:null},a.prototype.matchPath=function(e,t){void 0===t&&(t={}),""!==e||t.strictTrailingSlash||(e="/");var r=this.getSegmentsMatchingPath(e,t);if(!r)return null;var a=r.segments;if(a[0].absolute){var i=a[0].getParentSegments();a.reverse(),a.push.apply(a,i),a.reverse()}var s=a[a.length-1].findSlashChild();return s&&a.push(s),function(e){return e&&e.segments&&e.segments.length?{name:e.segments.map((function(e){return e.name})).filter((function(e){return e})).join("."),params:e.params,meta:n(e.segments)}:null}(r)},a.prototype.addRouteNode=function(e,t){void 0===t&&(t=!0);var r=e.name.split(".");if(1===r.length){if(-1!==this.children.map((function(e){return e.name})).indexOf(e.name))throw new Error('Alias "'+e.name+'" is already defined in route node');if(-1!==this.children.map((function(e){return e.path})).indexOf(e.path))throw new Error('Path "'+e.path+'" is already defined in route node');this.children.push(e),t&&this.sortChildren()}else{var n=this.getSegmentsByName(r.slice(0,-1).join("."));if(!n)throw new Error("Could not add route named '"+e.name+"', parent is missing.");e.name=r[r.length-1],n[n.length-1].add(e)}return this},a.prototype.checkParents=function(){if(this.absolute&&this.hasParentsParams())throw new Error("[RouteNode] A RouteNode with an abolute path cannot have parents with route parameters")},a.prototype.hasParentsParams=function(){if(this.parent&&this.parent.parser){var e=this.parent.parser;return e.hasUrlParams||e.hasSpatParam||e.hasMatrixParams||e.hasQueryParams||this.parent.hasParentsParams()}return!1},a.prototype.findAbsoluteChildren=function(){return this.children.reduce((function(e,t){return e.concat(t.absolute?t:[]).concat(t.findAbsoluteChildren())}),[])},a.prototype.findSlashChild=function(){return this.getNonAbsoluteChildren().filter((function(e){return e.parser&&/^\/(\?|$)/.test(e.parser.path)}))[0]},a.prototype.getSegmentsByName=function(e){var t=[],r=this.parser?[this]:this.children;return(this.parser?[""]:[]).concat(e.split(".")).every((function(e){var n=function(e,t){var r=t.filter((function(t){return t.name===e}));return r.length?r[0]:void 0}(e,r);return!!n&&(r=n.children,t.push(n),!0)}))?t:null},a.prototype.getSegmentsMatchingPath=function(e,t){var n=function e(t,n,a,i,s){void 0===i&&(i={});for(var o=i.queryParamsMode,u=void 0===o?"default":o,l=i.strictTrailingSlash,h=void 0!==l&&l,d=i.strongMatching,c=void 0===d||d,p=i.caseSensitive,f=void 0!==p&&p,m=1===t.length&&""===t[0].name,v=function(t){var o,l=null,d=void 0,p=n;if("/"===s&&"/"===t.path&&(p="/"+n),t.children.length||(l=t.parser.test(p,{caseSensitive:f,strictTrailingSlash:h,queryParams:i.queryParams,urlParamsEncoding:i.urlParamsEncoding})),l||(l=t.parser.partialTest(p,{delimited:c,caseSensitive:f,queryParams:i.queryParams,urlParamsEncoding:i.urlParamsEncoding})),l){var v=t.parser.build(l,{ignoreSearch:!0,urlParamsEncoding:i.urlParamsEncoding});h||t.children.length||(v=v.replace(/\/$/,"")),d=0===p.toLowerCase().indexOf(v.toLowerCase())?p.slice(v.length):p,h||t.children.length||(d=d.replace(/^\/\?/,"?"));var g=r.omit((o=p.replace(v,""),o.split("?")[1]||""),t.parser.queryParams,i.queryParams).querystring;if(d=function(e){return e.split("?")[0]}(d)+(g?"?"+g:""),h||m||"/"!==d||/\/$/.test(v)||(d=""),a.segments.push(t),Object.keys(l).forEach((function(e){return a.params[e]=l[e]})),!m&&!d.length)return{value:a};if(!m&&"strict"!==u&&0===d.indexOf("?")){var P=r.parse(d.slice(1),i.queryParams);return Object.keys(P).forEach((function(e){return a.params[e]=P[e]})),{value:a}}var y=t.getNonAbsoluteChildren();return y.length?{value:e(y,d,a,i,v)}:{value:null}}},g=0,P=t;g<P.length;g++){var y=v(P[g]);if("object"==typeof y)return y.value}return null}((this.parser?[this]:this.children).reduce((function(e,t){return e.concat(t,t.findAbsoluteChildren())}),[]),e,{segments:[],params:{}},t);return n&&1===n.segments.length&&""===n.segments[0].name?null:n},a}();
//# sourceMappingURL=route-node.cjs.production.min.js.map
